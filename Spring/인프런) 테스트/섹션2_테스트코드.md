# UserRepository Test 

```JAVA
@ExtendWith(SpringExtension.clss) // DataJpaTest에 내장되어 있으므로 생략 가능
@TestPropertySource("classpath:test-application.properties") //기본 설정 되어 있음
@DataJpaTest(showsql=true)
public class UserRepositoryTest{

	@Autowried
	private UserRepository userRepository;
	
	@Test
	void UserRepository_가_제대로_연결되었다(){
		// given
		UserEntity userEntity = new UserEntity();
		userEntity.setEmail("test@naverm.com");
		userEntity.setAddress("Seoul");
		userEntity.setNickname("test");
		userEntity.setStatus(UserStauts.ACTIVE);
		userEntity.setCertificationCode("aaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa");
		
		// when
		UserEntity result = userRepository.save(userEntity);
		
		// then
		assertThat(result.getId()).isNotNull();
	}

	@Test
	void findByIdAndStatus_로_유저_데이터_찾아올_수_있다() {
		// given 
		UserEntity userEntity = new UserEntity();
		userEntity.setId(1L);
		userEntity.setEmail("test@naverm.com");
		userEntity.setAddress("Seoul");
		userEntity.setNickname("test");
		userEntity.setStatus(UserStauts.ACTIVE);
		userEntity.setCertificationCode("aaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa");

		// when 
		userRepository.save(userEntity);
		Optional<UserEntity> result = userRepository.findByIdAndStatus(1,
		UserStatus.ACTIVE);

		// then
		asserThat(result.isPresent()).isTrue();
	}
	
	@Test
	void findByIdAndStatus_는_데이터가_없으면_Optional_empty() {
		// given 
		UserEntity userEntity = new UserEntity();
		userEntity.setId(1L);
		userEntity.setEmail("test@naverm.com");
		userEntity.setAddress("Seoul");
		userEntity.setNickname("test");
		userEntity.setStatus(UserStauts.ACTIVE);
		userEntity.setCertificationCode("aaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa");

		// when 
		userRepository.save(userEntity);
		Optional<UserEntity> result = userRepository.findByIdAndStatus(1,
		UserStatus.ACTIVE);

		// then
		asserThat(result.isEmpty()).isTrue();
	}

	@Test
	void findByEmailAndStatus_로_유저_데이터_찾아올_수_있다() {
		// given 
		UserEntity userEntity = new UserEntity();
		userEntity.setId(1L);
		userEntity.setEmail("test@naverm.com");
		userEntity.setAddress("Seoul");
		userEntity.setNickname("test");
		userEntity.setStatus(UserStauts.ACTIVE);
		userEntity.setCertificationCode("aaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa");

		// when 
		userRepository.save(userEntity);
		Optional<UserEntity> result = userRepository.findByEmailAndStatus(
		"test@naverm.com",UserStatus.ACTIVE);

		// then
		asserThat(result.isPresent()).isTrue();
	}
	
	@Test
	void findByEmailAndStatus_는_데이터가_없으면_Optional_empty() {
		// given 
		UserEntity userEntity = new UserEntity();
		userEntity.setId(1L);
		userEntity.setEmail("test@naverm.com");
		userEntity.setAddress("Seoul");
		userEntity.setNickname("test");
		userEntity.setStatus(UserStauts.ACTIVE);
		userEntity.setCertificationCode("aaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa");

		// when 
		userRepository.save(userEntity);
		Optional<UserEntity> result = userRepository.findByEmailAndStatus(
		"test@naverm.com",UserStatus.ACTIVE);

		// then
		asserThat(result.isEmpty()).isTrue();
	}
}
```

단일 테스트를 하면 성공하는데, 전체 테스트를 돌리면 실패한다.
-> 대표적인 비결정적 테스트. 테스트 메서드가 별렬로 처리되는데 동시성 제어가 안되어 발생. 따라서 아래와 같이 수정해줘야함. 

```java
@ExtendWith(SpringExtension.clss) // DataJpaTest에 내장되어 있으므로 생략 가능
@TestPropertySource("classpath:test-application.properties") //기본 설정 되어 있음
@Sql("/sql/user-repository-test-data.sql`")
@DataJpaTest(showsql=true)
public class UserRepositoryTest{

	@Autowried
	private UserRepository userRepository;

	@Test
	void findByIdAndStatus_로_유저_데이터_찾아올_수_있다() {
		// given 
		// when 
		Optional<UserEntity> result = userRepository.findByIdAndStatus(1,
		UserStatus.ACTIVE);

		// then
		asserThat(result.isPresent()).isTrue();
	}
	
	@Test
	void findByIdAndStatus_는_데이터가_없으면_Optional_empty() {
		// given 
		// when 
		Optional<UserEntity> result = userRepository.findByIdAndStatus(1,
		UserStatus.ACTIVE);

		// then
		asserThat(result.isEmpty()).isTrue();
	}

	@Test
	void findByEmailAndStatus_로_유저_데이터_찾아올_수_있다() {
		// given 
		// when 
		Optional<UserEntity> result = userRepository.findByEmailAndStatus(
		"test@naverm.com",UserStatus.ACTIVE);

		// then
		asserThat(result.isPresent()).isTrue();
	}
	
	@Test
	void findByEmailAndStatus_는_데이터가_없으면_Optional_empty() {
		// given 
		// when 
		Optional<UserEntity> result = userRepository.findByEmailAndStatus(
		"test@naverm.com",UserStatus.ACTIVE);

		// then
		asserThat(result.isEmpty()).isTrue();
	}
}
```


`user-repository-test-data.sql`
```SQL
insert into `users` (`id`, `email`,`nickname`,`address`,`certification_code`,`status`,`last_login_at`)
values (1,`test@naverm.com`,`test`,`Seoul`,`aaaaaa-aaaa-aaaa-aaaa-
		aaaaaaaaaaaa`,`ACTIVE`,`0`)
```
# UserSerivce Test

get 과 find 컨벤션 
get 은 애초에 데이터가 없으면 에러를 던진다는 의미가 내포되어 있다. 
- findByIdOrElseThrow  / getById
Optional을 반환하는 ~ById 는 findById가 더 적절하다. 

```java

@SpringBootTest
@Sql("/sql/user-service-test-data.sql`")
public class UserSerivceTest{

	@Autowried
	private UserService userSerivce;

	@Test
	void getByEmail은_ACTIVE_상태인_유저를_찾아올_수_있다(){
	
	}

}	
```
