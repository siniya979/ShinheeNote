# JOIN

## 특정 기간동안 대여 가능한 자동차들의 대여비용 구하기 (Lv4)

``` SQL
select car_id
     , CAR_TYPE
     , round(daily_fee*30*(1-discount_rate*0.01)) as FEE
from CAR_RENTAL_COMPANY_CAR c
join CAR_RENTAL_COMPANY_DISCOUNT_PLAN p using (car_type)
where car_type in ('세단', 'SUV')
and DURATION_TYPE = '30일 이상'
and car_id not in (
                    select car_id 
                    from CAR_RENTAL_COMPANY_RENTAL_HISTORY 
                    where END_DATE > '2022-11-01'
                      and START_DATE < '2022-11-30' 
                  )
having fee >= 500000 and fee <= 2000000
order by daily_fee desc, c.car_type, c.car_id desc;
```

**실행 순서**

> 1. From CAR_RENTAL_COMPANY_CAR 과 CAR_RENTAL_COMPANY_DISCOUNT_PLAN를 CAR_TYPE 기준으로 조인
> 2. WHERE 절 
> 3. SELECT 절 
> 4. HAVING 절
> 5. ORDER BY 절

* `fee >= 500000 and fee <= 2000000 ` 를 `HAVING` 절에 작성한 이유는 별칭을 사용하기 위해서다. 

```sql
and round(daily_fee*30*(1-discount_rate*0.01)) >= 500000 
and round(daily_fee*30*(1-discount_rate*0.01)) <= 2000000
```

- select 절이 where 절 보다 실행순서가 빠르기 때문에 별칭을 사용할 수 없으므로 where 절에 넣고 싶다면 위와 같이 별칭 없이 코드를 작성하면 된다. 

> GROUP BY 절에는 별칭 사용 가능


## 5월 식품들의 총매출 조회하기

```SQL
SELECT PRODUCT_ID,PRODUCT_NAME, SUM(AMOUNT*PRICE) AS TOTAL_SALES
FROM FOOD_ORDER 
JOIN FOOD_PRODUCT USING (PRODUCT_ID)
WHERE PRODUCE_DATE LIKE '2022-05-%'
GROUP BY PRODUCT_ID
ORDER BY TOTAL_SALES DESC, PRODUCT_ID ;
```

문제 조건 중 하나가 `생산일자가 2022년 5월인 식품들 ` 였다. 
맞게 풀었다 생각했는데 계속 틀렸다는 결과를 받아서 헤맸는데 해당 조건의 문제였다. 

```SQL 
WHERE PRODUCE_DATE >= '2022-05-01'
```
위와 같이 작성을 했었는데, 이렇게 되면 5월인 식품이 아니라 2022년 5월 이후 모든 상품을 조회하기 때문에 오답이었다. 


#  상품을 구매한 회원 비율 구하기

``` SQL
SELECT  YEAR(O.SALES_DATE) AS YEAR,
        MONTH(O.SALES_DATE) AS MONTH,       
        COUNT(DISTINCT O.USER_ID) AS PUCHASED_USERS ,
        ROUND(COUNT(DISTINCT O.USER_ID) /
              (SELECT COUNT(USER_ID) 
               FROM USER_INFO 
               WHERE YEAR(JOINED) = 2021),1
             ) AS PUCHASED_RATIO
FROM ONLINE_SALE O
JOIN USER_INFO U 
ON  U.USER_ID = O.USER_ID
WHERE YEAR(U.JOINED) = 2021
GROUP BY YEAR, MONTH
ORDER BY YEAR, MONTH;
```

계속 틀려서 열받은 문제. 
이유는 SELECT 문의 서브쿼리에서 
`YEAR(JOINED)` 부분은 `YEAR()`