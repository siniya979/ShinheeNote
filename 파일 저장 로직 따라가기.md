# GIS 수정의뢰 등록 API(스마트GIS)

@PostMapping(path = "/api/gischg", params = "from=smart")

## Request 

MobileUserInfo mobUserInfo,  
List<MultipartFile> attachFiles,  
SmartGisChangeRequest request


## Service 시작 
gisChangeService.requestSmartGisChange(attachFiles, request)

1. 도면 Update 

``` java
Tuple2<File, byte[]> attachFile = getTempFileFromBase64(chgReq.getBlueprintDraftDesc());
```

``` java
private Tuple2<File, byte[]> getTempFileFromBase64(String base64) {  
    Tuple2<String, byte[]> fileInfo = Base64ImgConverter.convertToImage(base64);  
    return Tuple.of(tempStorage.save(fileInfo._2, "GC", fileInfo._1()), fileInfo._2());  
}
```

Base64ImgConverter.convertToImage(base64) -> base64 문자열을 이미지 파일로 변환 
Tuple2<String, byte[]> -> String : 확장자 문자열 / Byte[] : 이미지 파일의 바이트 배열 

return Tuple.of(tempStorage.save(fileInfo._2, "GC", fileInfo._1()), fileInfo._2());


```Java
public File save(byte[] bytes, String prefix, String ext) {  
    return saveInternal(prefix, ext,  
          targetFile -> {  
             try {  
                FileCopyUtils.copy(bytes, targetFile);  
             } catch (IOException e) {  
                throw new TmpeFileStorageException(e);  
             }  
          });  
}
```

`prefix : 앞에 붙는 단어 ex) GC (사내규칙) `
`extension : 확장자 ex) jpg`

```java
private File saveInternal(String prefix, String extension, Consumer<File> writer) {
	"고유한 파일명 생성, 생성날짜시간+T+1000~9999 사이 난수"
     String name = DateUtil.format(LocalDateTime.now(), "yyyyMMddHHmmss") +
                             "T" + ThreadLocalRandom.current().nextInt(1000, 10000); 

	 "최종 파일명 생성, 프리픽스+위에서 생성한 이름 +확장자"
	String fileName = (StringUtils.hasText(prefix) ? prefix.trim() : "") + name 
                             + (StringUtils.hasText(extension) ? "." + extension : ""); 

	try { 
	    Path targetFolder = Paths.get(basePath, DateUtil.yyyymmdd());
	    if (Files.notExists(targetFolder)) {
	        Files.createDirectories(targetFolder);
	    } 
	    File targetFile = targetFolder.resolve(fileName).toFile(); 
	    writer.accept(targetFile);
	    return targetFile; 
	} catch (IllegalStateException | IOException e) { 
        throw new TmpeFileStorageException(e);
    }
 }
```

## 도면 저장 

``` Java
//도면 A11.A1AT_FILE_INFO에 DB저장  
UploadResponse uploadResult = uploadAttachFile(chgReq, attachFile._1);
```


``` Java
private UploadResponse uploadAttachFile(SmartGisChangeRequest chgReq, File file) {  
    FileUploadRequest fileUploadReq = FileUploadRequest.builder()  
          .employeeId(chgReq.getEmployeeId())  
          .cellphone(chgReq.getCellphone())  
          .file(file)  
          .path("/exdat01/d31")  
          .fileCode("D10")  
          .build();  
    return fileUploadService.upload(fileUploadReq);  
}
```

``` Java
public UploadResponse upload(FileUploadRequest req) {  
	"업로드할 경로 http://nmis.seoulgas.co.kr 이후 경로"
    String uploadPath = req.getPath();  
    "업로드할 때 사용할 파일이름"
    String uploadFileName = StringUtils.hasText(req.getUploadFileName()) ? req.getUploadFileName()  
          : req.getFile().getName();  
          
	"MIS 스토리지 업로드 - API 호출"
    fileUploader.upload(uploadPath, uploadFileName, req.getFile());  

	 "FileInfoSaveRequest 객체는 회사 파일 총괄 테이블에 저장될 컬럼들 보유.  파일사이즈, 파일명, 원본파일명,시스템구분(fileCode), 파일저장경로 등등"
    FileInfoSaveRequest saveReq = FileInfoSaveRequest.builder()  
          .fileName(uploadFileName)  
          .orgFileName(req.getFile().getName())  
          .fileCode(req.getFileCode())  
          .filePath(uploadPath)  
          .fileSize(req.getFile().length())  
          .createInfo(CommonFactory.createCreateInfo(req.getEmployeeId(), req.getCellphone()))  
          .build();  

		"파일 인포 생성(아래 코드 첨부) - 도면 이미지를 A11.A1AT_FILE_INFO에 저장" 
		FileInfo fileInfo = fileInfoSaveService.saveFileInfo(saveReq);
	  
    return UploadResponse.builder()  
          .fileId(fileInfo.getFileId())  
          .fileName(fileInfo.getFileName())  
          .orgFileName(fileInfo.getOrgFileName())  
          .fileCode(fileInfo.getFileCode())  
          .filePath(fileInfo.getFilePath())  
          .fileSize(fileInfo.getFileSize())  
          .build();  
}
```


```Java
"MIS 스토리지 업로드 - API 호출 "
public void upload(String filePath, String fileName, File file) {  
    RestTemplate restTemplate = new RestTemplate();  
    HttpHeaders headers = new HttpHeaders();  
    headers.set("file-name", fileName);  
    if (filePath != null) {  
       headers.set("file-path", filePath);  
    }  
    headers.setContentType(MediaType.MULTIPART_FORM_DATA);  
      
    SimpleClientHttpRequestFactory requestFactory = new SimpleClientHttpRequestFactory();  
    requestFactory.setBufferRequestBody(false);  
    restTemplate.setRequestFactory(requestFactory);  
      
    HttpEntity<Resource> requestEntity = new HttpEntity<>(new FileSystemResource(file), headers);  
    try {  
       restTemplate.exchange(uploaderUrl,  
             HttpMethod.POST,  
             requestEntity,  
             String.class);  
    } catch (HttpServerErrorException ex) {  
       String localFile = file == null ? "null" :  
          file.getName() + " " + file.length();  
       logger.error("fail to upload file [path={}, name={}, localFile={}] to mis: err={}]", filePath, fileName, localFile, ex.getMessage());  
       throw new MisFileUploaderServerException(ex.getResponseBodyAsString(), ex);  
    }  
}
```

```Java
public FileInfo saveFileInfo(FileInfoSaveRequest saveReq) {  

	" SELECT  A11.SQ_FILE_NUM.NEXTVAL as fileIdFROM  DUAL 쿼리 실행해서 파일Id 값 생성"
    Long nextFileId = fileInfoDao.nextFileId();  

    FileInfo fileInfo = FileInfo.builder()  
          .fileId(nextFileId)  
          .fileName(saveReq.getFileName())  
          .orgFileName(saveReq.getOrgFileName())  
          .fileCode(saveReq.getFileCode())  
          .filePath(saveReq.getFilePath())  
          .fileSize(saveReq.getFileSize())  
          .createInfo(saveReq.getCreateInfo())  
          .build();  

	" 생성한 파일인포 A11.A1AT_FILE_INFO 테이블에 저장 "
    logger.info("FileInfo ", fileInfo.toString());  
    fileInfoRepository.saveAndFlush(fileInfo);  
    return fileInfo;  
}
```

위 과정에서 얻어낸 것은 
1. 도면 이미지 파일을 A11.A1AT_FILE_INFO 테이블에 저장
2. UploadResponse 리턴 
``` Java
public class UploadResponse {  
    private Long fileId; // 화일관리번호  
    private String mainterNum; // 화일명  
    private String fileName; // 화일명  
    private String orgFileName; // 원본화일명  
    private String fileCode; // 시스템구분  
    private String filePath; // 화일저장경로  
    private Long fileSize; // 화일크기  
}
```

<h1>다시 메인 서비스 메소드로 돌아옴</h1>

```Java
BluePrintAttach attach = BluePrintAttach.builder()  
       .blueprintDraftDesc(attachFile._2())  "이미지 바이트 배열"
       .origAttachFileNm(uploadResult.getOrgFileName())  
       .attachFilePath(uploadResult.getFilePath())  
       .attachFileSize(uploadResult.getFileSize())  
       .attachFileNm(uploadResult.getFileName())  
       .fileId(uploadResult.getFileId())  
       .build();
```

```Java
"도면 D1JT_ATTACH_GIS_CHG에 DB저장, D11.D1ET_GIS_CHG에 DB저장"
GisChg gisChg = internalRequestGisChange(chgReq, GisChgReqPath.SMART_GIS, attach);
``측정의뢰번호 리턴`
말그대로임 


```Java
"D11.D1ET_SMART_DIST_MEAS_REG 에 DB저장 "
""
String nextReqNum = smartMeasureSaver.save(gisChg, chgReq);
```

```Java
public String save(GisChg gisChg, SmartGisChangeRequest chgReq) {  
    GisChgAttach attach = gisChg.getAttach();  
    SmartMeasureFromGisChgRequest saveRequest = SmartMeasureFromGisChgRequest.builder()
	    ..생략...build();
	return saveService.saveSmartDistanceMeasureFromGisChg(saveRequest);
```
```Java
public String saveSmartDistanceMeasureFromGisChg(SmartMeasureFromGisChgRequest saveRequest) {  

      "SELECT to_char(sysdate, 'yyyymm') || LPAD(NVL(MAX(SUBSTR(MEAS_REQ_NUM, 7, 5)), 0) + 1, 5, '0') " +  
       "FROM D11.D1ET_SMART_DIST_MEAS_REG where SUBSTR(MEAS_REQ_NUM, 1, 6) = to_char(sysdate, 'yyyymm')  쿼리를 실행. 리턴값 String nextReqNum" 
    String nextReqNum = smartDistMeasRepository.generateNextReqNum();  

	"SmartDistMeas 생성하는 메소드"
    SmartDistMeas meas = SmartDistMeasFactory.createFromGisChg(  
          saveRequest,  
          nextReqNum);  

	"D11.D1ET_SMART_DIST_MEAS_REG 테이블에 저장"
	"nextReqNum은 measReqNum 이다, 측정의뢰번호 "
    smartDistMeasRepository.saveAndFlush(meas);  
      
    return nextReqNum;  
}
```


<h1>다시 메인 서비스 메소드로 돌아옴</h1>

``` Java

"도면 외의 첨부 파일 저장하기 위한 로직 추가" 
"attachFiles 는 멀티파트파일로 넘어온 데이터"
if(attachFiles!=null) {  
    List<File> attfiles = attachFiles.stream()  
          .map(pic -> tempStorage.save(pic, ""))  
          .collect(Collectors.toList());  
    chgReq.setChumbus(attfiles);  
}

```


``` Java

public File save(MultipartFile multiPartFile, String prefix) {  
	"확장자 구하기 "
    String extension = FileUtils.refineExtension(FileUtils.getExtension(multiPartFile.getOriginalFilename()));  
	"saveInternal 메소드 실행"
    return saveInternal(prefix, extension,  
          targetFile -> {  
             try {  
                multiPartFile.transferTo(targetFile);  
             } catch (IllegalStateException | IOException e) {  
                throw new TmpeFileStorageException(e);  
             }  
          });  
}
```
