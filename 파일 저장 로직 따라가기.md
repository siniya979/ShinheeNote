# GIS 수정의뢰 등록 API(스마트GIS)

@PostMapping(path = "/api/gischg", params = "from=smart")

## Request 

MobileUserInfo mobUserInfo,  
List<MultipartFile> attachFiles,  
SmartGisChangeRequest request


## Service 시작 
gisChangeService.requestSmartGisChange(attachFiles, request)

1. 도면 Update 

``` java
Tuple2<File, byte[]> attachFile = getTempFileFromBase64(chgReq.getBlueprintDraftDesc());
```

``` java
private Tuple2<File, byte[]> getTempFileFromBase64(String base64) {  
    Tuple2<String, byte[]> fileInfo = Base64ImgConverter.convertToImage(base64);  
    return Tuple.of(tempStorage.save(fileInfo._2, "GC", fileInfo._1()), fileInfo._2());  
}
```

Base64ImgConverter.convertToImage(base64) -> base64 문자열을 이미지 파일로 변환 
Tuple2<String, byte[]> -> String : 확장자 문자열 / Byte[] : 이미지 파일의 바이트 배열 

return Tuple.of(tempStorage.save(fileInfo._2, "GC", fileInfo._1()), fileInfo._2());


```Java
public File save(byte[] bytes, String prefix, String ext) {  
    return saveInternal(prefix, ext,  
          targetFile -> {  
             try {  
                FileCopyUtils.copy(bytes, targetFile);  
             } catch (IOException e) {  
                throw new TmpeFileStorageException(e);  
             }  
          });  
}
```

`prefix : 앞에 붙는 단어 ex) GC (사내규칙) `
`extension : 확장자 ex) jpg`

```java
private File saveInternal(String prefix, String extension, Consumer<File> writer) {
     String name = DateUtil.format(LocalDateTime.now(), "yyyyMMddHHmmss") +
                             "T" + ThreadLocalRandom.current().nextInt(1000, 10000); 

String fileName = (StringUtils.hasText(prefix) ? prefix.trim() : "") + name 
                             + (StringUtils.hasText(extension) ? "." + extension : ""); 

try { 
    Path targetFolder = Paths.get(basePath, DateUtil.yyyymmdd());
     if (Files.notExists(targetFolder)) {
         Files.createDirectories(targetFolder);
      } 
     File targetFile = targetFolder.resolve(fileName).toFile(); writer.accept(targetFile);
      return targetFile; } catch (IllegalStateException | IOException e) { throw new TmpeFileStorageException(e); } }
```
